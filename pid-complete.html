<script type="text/javascript">

  function validateNumber(v, opt) {
    if (v !== '' && v !== undefined && isFinite(v) && !isNaN(v)) {
      return true;
    }

    if (opt && opt.label) {
      return RED._("validator.errors.invalid-num-prop", {
          prop: opt.label
        });
    }
    return opt ? RED._("validator.errors.invalid-num") : false;
  }

  RED.nodes.registerType("pid-complete", {
    category: "PID",
    color: "#FFCC66",
    defaults: {
      name: { value: "PID" },
      sampleInterval: { value: 1, required: true, label: "Calc. Interval", validate: validateNumber },
      outMin: { value: 0, required: true, label: "Out Min", validate: (v, opt) => {
          let vIsValid = validateNumber(v, opt);
          if (vIsValid !== true) {
            return vIsValid;
          }
          if (v != $("#node-input-outMax").val()) {
            return true;
          }
          return "Out Min: cannot equal Out Max";
        }
      },
      outMax: { value: 1, required: true, label: "Out Max", validate: (v, opt) => {
          let vIsValid = validateNumber(v, opt);
          if (vIsValid !== true) {
            return vIsValid;
          }
          if (v != $("#node-input-outMin").val()) {
            return true;
          }
          return "Out Max: cannot equal Out Min";
        }
      },
      disabledOut: { value: 0, required: true, label: "Disabled Output", validate: (v,opt) => {
          let vIsValid = validateNumber(v, opt);
          if (vIsValid !== true) {
            return vIsValid;
          }
          let outMin = $("#node-input-outMin").val();
          let outMax = $("#node-input-outMax").val();
          if (validateNumber(outMin) !== true || validateNumber(outMax) !== true) {
            // If outMin and outMax aren't set yet, we don't need to trigger this validator
            return true;
          }
          let action =  outMin < outMax ? true : false;
          let result = false;
          if (action) {
            result = (v >= outMin) && (v <= outMax);
          } else {
            result = (v >= outMax) && (v <= outMin);
          }
          if (result) {
            return result;
          }
          return "Disabled Output: not within Out Min and Out Max";
        }
      },
      PonM: { value: false },
      DonM: { value: false },
      kp: { value: 1, required: true, label: "Kp", validate: RED.validators.typedInput("kpType", false) },
      kpType: { value: "num" },
      ki: { value: 0, required: true, label: "Ki", validate: RED.validators.typedInput("kiType", false) },
      kiType: { value: "num" },
      kd: { value: 0, required: true, label: "Kd", validate: RED.validators.typedInput("kdType", false) },
      kdType: { value: "num" }
    },
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-sliders",
    outputLabels: [],
    label: function () {
      return this.name || "pid-complete";
    },
    oneditprepare: function() {

      $("#node-input-name").typedInput({
        types: ["str"]
      });

      $("#node-input-sampleInterval").typedInput({
        types: ["num"]
      });

      $("#node-input-outMin").typedInput({
        types: ["num"]
      });

      $("#node-input-outMax").typedInput({
        types: ["num"]
      });

      $("#node-input-disabledOut").typedInput({
        types: ["num"]
      });

      $("#node-input-kp").typedInput({
        type: "num",
        types: ["num", "flow", "global"],
        typeField: "#node-input-kpType"
      });

      $("#node-input-ki").typedInput({
        type: "num",
        types: ["num", "flow", "global"],
        typeField: "#node-input-kiType"
      });

      $("#node-input-kd").typedInput({
        type: "num",
        types: ["num", "flow", "global"],
        typeField: "#node-input-kdType"
      });

    }
  });


</script>


<script type="text/html" data-template-name="pid-complete">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-kp">Kp</label>
    <input type="text" id="node-input-kp" />
    <input type="hidden" id="node-input-kpType" />
  </div>
  <div class="form-row">
    <label for="node-input-ki">Ki</label>
    <input type="text" id="node-input-ki" />
    <input type="hidden" id="node-input-kiType" />
  </div>
  <div class="form-row">
    <label for="node-input-kd">Kd</label>
    <input type="text" id="node-input-kd" />
    <input type="hidden" id="node-input-kdType" />
  </div>
  <div class="form-row">
    <label for="node-input-outMin">Min Output</label>
    <input type="text" id="node-input-outMin" />
  </div>
  <div class="form-row">
    <label for="node-input-outMax">Max Output</label>
    <input type="text" id="node-input-outMax" />
  </div>
  <div class="form-row">
    <label for="node-input-sampleInterval">Calc. Interval (s)</label>
    <input type="text" id="node-input-sampleInterval" />
  </div>
  <div class="form-row">
    <label for="node-input-disabledOut">Disabled Output</label>
    <input type="text" id="node-input-disabledOut" />
  </div>
  <div class="form-row">
    <label style="width:auto" for="node-input-PonM" class="fa fa-arrow-right">Proportional on Measurement</label>
    <input type="checkbox" id="node-input-PonM"  style="display:inline-block; width:auto; vertical-align:top;"/>
  </div>

  <div class="form-row">
    <label style="width:auto" for="node-input-DonM" class="fa fa-arrow-right">Derivative on Measurement</label>
    <input type="checkbox" id="node-input-DonM"  style="display:inline-block; width:auto; vertical-align:top;" />
  </div>

</script>

<script type="text/html" data-help-name="pid-complete">
  <p>A node to performe PID calculations and autotuning.</p>
</script>
