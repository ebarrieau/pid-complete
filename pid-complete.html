<script type="text/javascript">
  RED.nodes.registerType("pid-complete", {
    category: "PID",
    color: "#FFCC66",
    defaults: {
      name: { value: "PID" },
      sampleInterval: { value: 1, validate: RED.validators.number() },
      outMin: { value: 0, validate: (v, opt) => {
          if (RED.validators.number(v) && (v != $("#node-input-outMax").val())) {
            return true;
          }
          if (opt) {
            return "Min and Max output cannot be the same";
          }
        }
      },
      outMax: { value: 1, validate: (v, opt) => {
          if (RED.validators.number(v) && (v != $("#node-input-outMin").val())) {
            return true;
          }
          if (opt) {
            return "Min and Max output cannot be the same";
          }
        }
      },
      disabledOut: { value: 0, validate: (v, opt) => {
          let outMin = $("#node-input-outMin").val();
          let outMax = $("#node-input-outMax").val();
          let action =  outMin < outMax ? true : false;
          let result = false;
          if (action) {
            result = (v >= outMin) && (v <= outMax);
          } else {
            result = (v >= outMax) && (v <= outMin);
          }
          if (result) {
            return result;
          }
          if (opt) {
            return "Disabled output not within Min and Max output";
          }
        }
      },
      PonM: { value: false },
      DonM: { value: false },
      kp: { value: "1", validate:(v,opt) => {
          if ($("#node-input-kpType").val() == "num") {
            if (RED.validators.number(v)) {
              return true;
            }
            if (opt) {
              return "Kp input not a valid number";
            }
          } else {
            return true;
          }
        }
      },
      kpType: { value: "num" },
      ki: { value: "0", validate:(v,opt) => {
          if ($("#node-input-kiType").val() == "num") {
            if (RED.validators.number(v)) {
              return true;
            }
            if (opt) {
              return "Ki input not a valid number";
            }
          }else {
            return true;
          }
        }
      },
      kiType: { value: "num" },
      kd: { value: "0", validate:(v,opt) => {
          if ($("#node-input-kdType").val() == "num") {
            if (RED.validators.number(v)) {
              return true;
            }
            if (opt) {
              return "Kd input not a valid number";
            }
          } else {
            return true;
          }
        }
      },
      kdType: { value: "num" }
    },
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-sliders",
    outputLabels: [],
    label: function () {
      return this.name || "pid-complete";
    },
    oneditprepare: function() {

      $("#node-input-name").typedInput({
        types: ["str"]
      });

      $("#node-input-sampleInterval").typedInput({
        types: ["num"]
      });

      $("#node-input-outMin").typedInput({
        types: ["num"]
      });

      $("#node-input-outMax").typedInput({
        types: ["num"]
      });

      $("#node-input-disabledOut").typedInput({
        types: ["num"]
      });

      $("#node-input-kp").typedInput({
        type: "num",
        types: ["num", "flow", "global"],
        typeField: "#node-input-kpType"
      });

      $("#node-input-ki").typedInput({
        type: "num",
        types: ["num", "flow", "global"],
        typeField: "#node-input-kiType"
      });

      $("#node-input-kd").typedInput({
        type: "num",
        types: ["num", "flow", "global"],
        typeField: "#node-input-kdType"
      });

    }
  });


</script>


<script type="text/html" data-template-name="pid-complete">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div class="form-row">
    <label for="node-input-kp">Kp</label>
    <input type="text" id="node-input-kp" />
    <input type="hidden" id="node-input-kpType" />
  </div>
  <div class="form-row">
    <label for="node-input-ki">Ki</label>
    <input type="text" id="node-input-ki" />
    <input type="hidden" id="node-input-kiType" />
  </div>
  <div class="form-row">
    <label for="node-input-kd">Kd</label>
    <input type="text" id="node-input-kd" />
    <input type="hidden" id="node-input-kdType" />
  </div>
  <div class="form-row">
    <label for="node-input-outMin">Min Output</label>
    <input type="text" id="node-input-outMin" />
  </div>
  <div class="form-row">
    <label for="node-input-outMax">Max Output</label>
    <input type="text" id="node-input-outMax" />
  </div>
  <div class="form-row">
    <label for="node-input-sampleInterval">Calc. Interval (s)</label>
    <input type="text" id="node-input-sampleInterval" />
  </div>
  <div class="form-row">
    <label for="node-input-disabledOut">Disabled Output</label>
    <input type="text" id="node-input-disabledOut" />
  </div>
  <div class="form-row">
    <label style="width:auto" for="node-input-PonM" class="fa fa-arrow-right">Proportional on Measurement</label>
    <input type="checkbox" id="node-input-PonM"  style="display:inline-block; width:auto; vertical-align:top;"/>
  </div>

  <div class="form-row">
    <label style="width:auto" for="node-input-DonM" class="fa fa-arrow-right">Derivative on Measurement</label>
    <input type="checkbox" id="node-input-DonM"  style="display:inline-block; width:auto; vertical-align:top;" />
  </div>

</script>

<script type="text/html" data-help-name="pid-complete">
  <p>A node to performe PID calculations and autotuning.</p>
</script>
